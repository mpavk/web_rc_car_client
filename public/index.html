<!doctype html>
<html lang="uk">
    <head>
        <meta charset="utf-8" />
        <title>Pi WebRTC Receiver with Vehicle Control</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
            /* –í—ñ–¥–∑–µ—Ä–∫–∞–ª–µ–Ω–Ω—è –ø—Ä–∏–±—Ä–∞–Ω–æ */
            #video {
                /* transform: scaleX(-1); - –ü–†–ò–ë–†–ê–ù–û */
            }
            .disconnected {
                background-color: #fecaca;
                color: #991b1b;
            }
            .connecting {
                background-color: #dbeafe;
                color: #1e40af;
            }
            .connected {
                background-color: #d1fae5;
                color: #065f46;
            }
            .control-btn,
            .size-btn,
            #fullscreenBtn {
                padding: 0.75rem;
                text-align: center;
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                background-color: #f9fafb;
                transition: background-color 0.15s;
                user-select: none;
            }
            .control-btn {
                font-size: 1.5rem;
                padding: 1rem;
            }
            .control-btn:hover,
            .size-btn:hover,
            #fullscreenBtn:hover {
                background-color: #e5e7eb;
            }
            .control-btn:active,
            .size-btn:active,
            #fullscreenBtn:active {
                background-color: #d1d5db;
            }
            .size-btn.active {
                background-color: #3b82f6;
                color: white;
            }
            .fullscreen-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                z-index: 10;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .video-container:hover .fullscreen-btn {
                opacity: 1;
            }
            .fullscreen-btn:hover {
                background: rgba(0, 0, 0, 0.9);
            }
            .size-controls {
                display: flex;
                gap: 10px;
                align-items: center;
                justify-content: center;
                margin-bottom: 1rem;
            }
            @media (max-width: 768px) {
                .desktop-layout {
                    flex-direction: column;
                }
                .video-container {
                    width: 100% !important;
                    max-width: 100% !important;
                }
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen">
        <div class="container mx-auto p-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                Live Stream from Raspberry Pi with Vehicle Control
            </h3>

            <div class="flex justify-center mb-4">
                <div
                    id="status"
                    class="w-full max-w-md p-3 text-center rounded-lg shadow-md disconnected"
                >
                    Disconnected
                </div>
            </div>

            <div class="flex justify-center mb-6">
                <div
                    id="connectContainer"
                    class="w-full max-w-md bg-white p-6 rounded-lg shadow-md flex flex-col items-center"
                >
                    <label for="deviceId" class="text-gray-700 text-lg mb-2"
                        >Device ID:</label
                    >
                    <input
                        type="text"
                        id="deviceId"
                        placeholder="Enter device name"
                        value="vid"
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                    />
                    <div id="connectBtnContainer" class="w-full">
                        <button
                            id="connectBtn"
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
                        >
                            Connect to Stream
                        </button>
                    </div>
                    <div id="disconnectBtnContainer" class="w-full hidden">
                        <button
                            id="disconnectBtn"
                            class="w-full bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200"
                        >
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <div id="sizeControls" class="size-controls hidden">
                <span class="text-gray-700 font-medium">–†–æ–∑–º—ñ—Ä –≤—ñ–¥–µ–æ:</span>
                <button class="size-btn" data-size="small">–ú–∞–ª–µ–Ω—å–∫–∏–π</button>
                <button class="size-btn active" data-size="medium">
                    –°–µ—Ä–µ–¥–Ω—ñ–π
                </button>
                <button class="size-btn" data-size="large">–í–µ–ª–∏–∫–∏–π</button>
                <button class="size-btn" data-size="extra-large">
                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π
                </button>
            </div>

            <div class="desktop-layout flex gap-6 justify-center items-start">
                <div class="video-container relative" id="videoContainer">
                    <video
                        id="video"
                        autoplay
                        playsinline
                        muted
                        controls
                        class="border border-gray-300 rounded-lg shadow-md bg-black transition-all duration-300"
                        style="width: 800px; max-width: 90vw"
                    ></video>
                    <button class="fullscreen-btn" id="fullscreenBtn">
                        ‚õ∂ –ü–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω
                    </button>
                </div>
                <div
                    id="controlsContainer"
                    class="hidden bg-white p-6 rounded-lg shadow-md flex-shrink-0"
                    style="width: 320px"
                >
                    <h4
                        class="text-xl font-semibold text-gray-800 mb-4 text-center"
                    >
                        Vehicle Controls
                    </h4>
                    <div class="mb-4 w-full">
                        <label
                            for="speedSlider"
                            class="block text-gray-700 text-sm font-medium mb-1 text-center"
                            >Speed: <span id="speedValue">50</span>%</label
                        >
                        <input
                            type="range"
                            id="speedSlider"
                            min="0"
                            max="100"
                            value="50"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        />
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div></div>
                        <button id="forwardBtn" class="control-btn">‚Üë</button>
                        <div></div>
                        <button id="leftBtn" class="control-btn">‚Üê</button>
                        <button
                            id="stopBtn"
                            class="control-btn bg-red-500 text-white"
                        >
                            ‚ñ†
                        </button>
                        <button id="rightBtn" class="control-btn">‚Üí</button>
                        <div></div>
                        <button id="backwardBtn" class="control-btn">‚Üì</button>
                        <div></div>
                    </div>
                    <p class="text-center text-gray-600 mt-4 text-sm">
                        –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Å—Ç—Ä—ñ–ª–∫–∏ –∞–±–æ WASD —Ç–∞ –ø—Ä–æ–±—ñ–ª (—Å—Ç–æ–ø)
                    </p>
                </div>
            </div>
        </div>

        <script>
            let pc, ws;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 10;
            let reconnectTimer = null;
            let isManualDisconnect = false;
            let connectionLostTime = null;

            const statusEl = document.getElementById("status");
            const speedSlider = document.getElementById("speedSlider");
            const speedValue = document.getElementById("speedValue");
            const videoEl = document.getElementById("video");
            const videoContainer = document.getElementById("videoContainer");
            const fullscreenBtn = document.getElementById("fullscreenBtn");
            const sizeControls = document.getElementById("sizeControls");

            const connectBtnContainer = document.getElementById(
                "connectBtnContainer",
            );
            const disconnectBtnContainer = document.getElementById(
                "disconnectBtnContainer",
            );
            const connectBtn = document.getElementById("connectBtn");
            const disconnectBtn = document.getElementById("disconnectBtn");
            const controlsContainer =
                document.getElementById("controlsContainer");
            const deviceIdInput = document.getElementById("deviceId");

            // ‚úÖ --- –§–Ü–ù–ê–õ–¨–ù–ò–ô –®–¢–†–ò–•: –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑'—î–¥–Ω–∞–Ω–Ω—è --- ‚úÖ
            window.addEventListener("beforeunload", () => {
                isManualDisconnect = true;
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
                if (ws && ws.readyState === WebSocket.OPEN) {
                    console.log(
                        "Page is unloading. Closing WebSocket connection cleanly.",
                    );
                    ws.close(1001, "Page Unloaded");
                }
                if (pc) {
                    pc.close();
                }
            });

            // ‚úÖ --- –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ò–ô –†–ï–ö–û–ù–ï–ö–¢ --- ‚úÖ
            function scheduleReconnect() {
                if (
                    isManualDisconnect ||
                    reconnectAttempts >= maxReconnectAttempts
                ) {
                    if (reconnectAttempts >= maxReconnectAttempts) {
                        updateStatus(
                            "–ú–∞–∫—Å–∏–º—É–º —Å–ø—Ä–æ–± –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ—Å—è–≥–Ω—É—Ç–æ",
                            "disconnected",
                        );
                    }
                    return;
                }

                reconnectAttempts++;
                const delay = Math.min(
                    1000 * Math.pow(2, reconnectAttempts - 1),
                    30000,
                ); // –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–æ 30 —Å–µ–∫

                updateStatus(
                    `–†–µ–∫–æ–Ω–µ–∫—Ç —á–µ—Ä–µ–∑ ${Math.ceil(delay / 1000)}—Å (—Å–ø—Ä–æ–±–∞ ${reconnectAttempts}/${maxReconnectAttempts})`,
                    "connecting",
                );

                reconnectTimer = setTimeout(() => {
                    console.log(
                        `üîÑ Attempting reconnect ${reconnectAttempts}/${maxReconnectAttempts}`,
                    );
                    initConnection(true); // true –æ–∑–Ω–∞—á–∞—î —â–æ —Ü–µ —Ä–µ–∫–æ–Ω–µ–∫—Ç
                }, delay);
            }

            // ‚úÖ --- –î–ï–¢–ï–ö–¶–Ü–Ø –í–¢–†–ê–¢–ò –í–Ü–î–ï–û –°–ò–ì–ù–ê–õ–£ --- ‚úÖ
            function setupVideoMonitoring() {
                let lastVideoTime = 0;
                let videoCheckInterval = null;

                videoEl.addEventListener("timeupdate", () => {
                    lastVideoTime = Date.now();
                });

                videoEl.addEventListener("loadstart", () => {
                    console.log("üì∫ Video loading started");
                    lastVideoTime = Date.now();
                });

                videoEl.addEventListener("loadeddata", () => {
                    console.log("üì∫ Video data loaded");
                    lastVideoTime = Date.now();
                    connectionLostTime = null;
                });

                videoEl.addEventListener("stalled", () => {
                    console.log("üì∫ Video stalled");
                    if (!connectionLostTime) {
                        connectionLostTime = Date.now();
                    }
                });

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –≤—ñ–¥–µ–æ –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
                videoCheckInterval = setInterval(() => {
                    const now = Date.now();
                    const timeSinceLastVideo = now - lastVideoTime;

                    // –Ø–∫—â–æ –±—ñ–ª—å—à–µ 10 —Å–µ–∫—É–Ω–¥ –Ω–µ –±—É–ª–æ –≤—ñ–¥–µ–æ —ñ –∑'—î–¥–Ω–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–µ
                    if (
                        timeSinceLastVideo > 10000 &&
                        pc &&
                        pc.iceConnectionState === "connected"
                    ) {
                        console.log(
                            "‚ö†Ô∏è Video seems frozen, connection might be lost",
                        );
                        if (!connectionLostTime) {
                            connectionLostTime = now;
                            updateStatus(
                                "–°–∏–≥–Ω–∞–ª —Å–ª–∞–±–∫–∏–π, —Å–ø—Ä–æ–±–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è...",
                                "connecting",
                            );
                        }

                        // –Ø–∫—â–æ 20 —Å–µ–∫—É–Ω–¥ –Ω–µ–º–∞—î –≤—ñ–¥–µ–æ - —Ñ–æ—Ä—Å—É—î–º–æ —Ä–µ–∫–æ–Ω–µ–∫—Ç
                        if (timeSinceLastVideo > 20000) {
                            console.log(
                                "üîÑ Forcing reconnect due to video freeze",
                            );
                            if (pc) pc.close();
                        }
                    }
                }, 3000);

                return () => {
                    if (videoCheckInterval) {
                        clearInterval(videoCheckInterval);
                    }
                };
            }

            // –†–æ–∑–º—ñ—Ä–∏ –≤—ñ–¥–µ–æ
            const videoSizes = {
                small: "480px",
                medium: "800px",
                large: "1200px",
                "extra-large": "95vw",
            };
            document.querySelectorAll(".size-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    document
                        .querySelectorAll(".size-btn")
                        .forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");
                    const size = btn.getAttribute("data-size");
                    videoEl.style.width = videoSizes[size];
                    localStorage.setItem("videoSize", size);
                });
            });
            const savedSize = localStorage.getItem("videoSize") || "medium";
            document.querySelector(`[data-size="${savedSize}"]`).click();

            fullscreenBtn.addEventListener("click", () => {
                if (videoEl.requestFullscreen) videoEl.requestFullscreen();
                else if (videoEl.webkitRequestFullscreen)
                    videoEl.webkitRequestFullscreen();
                else if (videoEl.msRequestFullscreen)
                    videoEl.msRequestFullscreen();
            });
            videoEl.addEventListener("dblclick", () => fullscreenBtn.click());

            function resetUI() {
                updateStatus("Disconnected", "disconnected");
                controlsContainer.classList.add("hidden");
                sizeControls.classList.add("hidden");
                disconnectBtnContainer.classList.add("hidden");
                connectBtnContainer.classList.remove("hidden");
                deviceIdInput.disabled = false;
                videoEl.srcObject = null;
                connectionLostTime = null;

                // –û—á–∏—â–∞—î–º–æ —Ç–∞–π–º–µ—Ä —Ä–µ–∫–æ–Ω–µ–∫—Ç—É —è–∫—â–æ —Ü–µ –º–∞–Ω—É–∞–ª—å–Ω–∏–π –¥–∏—Å–∫–æ–Ω–µ–∫—Ç
                if (isManualDisconnect && reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            }

            function disconnect() {
                console.log("Disconnecting explicitly by user action...");
                isManualDisconnect = true;
                reconnectAttempts = 0;

                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(
                        JSON.stringify({
                            action: "disconnect",
                            device: deviceIdInput.value.trim(),
                        }),
                    );
                    ws.close(1000, "Client disconnected via button");
                }
                if (pc) {
                    pc.close();
                }
                resetUI();
            }

            function updateStatus(text, cls) {
                statusEl.textContent = text;
                statusEl.className = `w-full max-w-md p-3 text-center rounded-lg shadow-md ${cls}`;
            }

            speedSlider.addEventListener("input", () => {
                speedValue.textContent = speedSlider.value;
            });

            function sendCommand(direction, turn, speed) {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                const device = deviceIdInput.value.trim();
                const msg = {
                    device,
                    action: direction || turn ? "control" : "stop",
                };
                if (direction) msg.direction = direction;
                if (turn) msg.turn = turn;
                if (speed != null) msg.speed = parseInt(speed, 10);
                ws.send(JSON.stringify(msg));
            }

            async function initConnection(isReconnect = false) {
                const device = deviceIdInput.value.trim();
                if (!device) {
                    alert("Enter device ID");
                    return;
                }

                if (!isReconnect) {
                    isManualDisconnect = false;
                    reconnectAttempts = 0;
                }

                updateStatus(
                    isReconnect ? "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è..." : "Connecting...",
                    "connecting",
                );
                connectBtn.disabled = true;

                // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è
                if (pc) {
                    pc.close();
                }
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }

                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        {
                            urls: "turn:turn.metered.ca:80",
                            username: "openrelayproject",
                            credential: "openrelayproject",
                        },
                    ],
                });

                pc.addTransceiver("video", { direction: "recvonly" });

                // ‚úÖ --- –ü–û–ö–†–ê–©–ï–ù–ê –û–ë–†–û–ë–ö–ê –°–¢–ê–ù–£ ICE –ó'–Ñ–î–ù–ê–ù–ù–Ø --- ‚úÖ
                pc.oniceconnectionstatechange = () => {
                    const s = pc.iceConnectionState;
                    console.log("ICE connection state:", s);
                    if (s === "connected" || s === "completed") {
                        console.log("‚úÖ WebRTC connection established");
                        reconnectAttempts = 0; // –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –∑'—î–¥–Ω–∞–Ω–Ω—ñ
                        updateStatus("Connected", "connected");
                        controlsContainer.classList.remove("hidden");
                        sizeControls.classList.remove("hidden");
                        connectBtnContainer.classList.add("hidden");
                        disconnectBtnContainer.classList.remove("hidden");
                        deviceIdInput.disabled = true;
                        connectBtn.disabled = false;
                        setupVideoMonitoring(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤—ñ–¥–µ–æ
                    } else if (s === "checking") {
                        updateStatus("–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è...", "connecting");
                    } else if (s === "disconnected") {
                        console.log("‚ö†Ô∏è ICE connection disconnected");
                        updateStatus("–ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ", "disconnected");
                        if (!isManualDisconnect) {
                            scheduleReconnect();
                        }
                    } else if (s === "failed") {
                        console.log("‚ùå ICE connection failed");
                        updateStatus("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è", "disconnected");
                        connectBtn.disabled = false;
                        if (!isManualDisconnect) {
                            scheduleReconnect();
                        }
                    } else if (s === "closed") {
                        console.log("üîí ICE connection closed");
                        if (!isManualDisconnect) {
                            scheduleReconnect();
                        } else {
                            resetUI();
                        }
                    }
                };

                pc.ontrack = (e) => {
                    console.log("üì∫ Received video track");
                    if (videoEl.srcObject !== e.streams[0]) {
                        videoEl.srcObject = e.streams[0];
                        videoEl
                            .play()
                            .catch((err) =>
                                console.warn("Autoplay prevented:", err),
                            );
                    }
                };

                pc.onicecandidate = (evt) => {
                    if (evt.candidate && ws && ws.readyState === WebSocket.OPEN)
                        ws.send(
                            JSON.stringify({
                                device,
                                ...evt.candidate.toJSON(),
                            }),
                        );
                };

                const proto = location.protocol === "https:" ? "wss" : "ws";
                const wsUrl = `${proto}://${window.location.hostname}:8443/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log("üîå WebSocket connected");
                    ws.send(JSON.stringify({ action: "ready", device }));
                };

                ws.onmessage = async (evt) => {
                    let raw =
                        evt.data instanceof Blob
                            ? await evt.data.text()
                            : evt.data;

                    console.log("‚¨ÖÔ∏è RAW MESSAGE RECEIVED:", raw);

                    let msg;
                    try {
                        msg = JSON.parse(raw.trim());
                    } catch (e) {
                        console.error("‚ùå FAILED TO PARSE JSON:", e);
                        console.error("   The corrupted message was ->", raw);
                        return;
                    }
                    if (msg.device && msg.device !== device) return;

                    if (msg.sdp && msg.type === "offer") {
                        await pc.setRemoteDescription(
                            new RTCSessionDescription(msg),
                        );
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        ws.send(
                            JSON.stringify({
                                device,
                                type: answer.type,
                                sdp: answer.sdp,
                            }),
                        );
                    } else if (msg.candidate) {
                        await pc.addIceCandidate(new RTCIceCandidate(msg));
                    }
                };

                ws.onerror = (error) => {
                    console.error("‚ùå WebSocket error:", error);
                    updateStatus("–ü–æ–º–∏–ª–∫–∞ WebSocket", "disconnected");
                    connectBtn.disabled = false;
                    if (!isManualDisconnect) {
                        scheduleReconnect();
                    }
                };

                ws.onclose = (event) => {
                    console.log(
                        "üîå WebSocket closed:",
                        event.code,
                        event.reason,
                    );
                    if (!isManualDisconnect && event.code !== 1000) {
                        scheduleReconnect();
                    }
                };
            }

            connectBtn.addEventListener("click", () => {
                isManualDisconnect = false;
                initConnection();
            });
            disconnectBtn.addEventListener("click", disconnect);

            // –õ–æ–≥—ñ–∫–∞ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é
            const btns = {
                forwardBtn: { d: "forward", t: null },
                backwardBtn: { d: "backward", t: null },
                leftBtn: { d: null, t: "left" },
                rightBtn: { d: null, t: "right" },
            };
            Object.entries(btns).forEach(([id, { d, t }]) => {
                const el = document.getElementById(id);
                const send = () => sendCommand(d, t, speedSlider.value);
                el.addEventListener("mousedown", send);
                el.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    send();
                });
            });
            const stopEvents = ["mouseup", "mouseleave", "touchend"];
            Object.values(btns).forEach((cmd) => {
                const btnId = Object.keys(btns).find(
                    (key) => btns[key].d === cmd.d && btns[key].t === cmd.t,
                );
                if (btnId) {
                    const btn = document.getElementById(btnId);
                    stopEvents.forEach((evt) =>
                        btn.addEventListener(evt, () =>
                            sendCommand(null, null),
                        ),
                    );
                }
            });
            document
                .getElementById("stopBtn")
                .addEventListener("click", () => sendCommand(null, null));

            // ‚úÖ --- –í–ò–ü–†–ê–í–õ–ï–ù–û –ö–ï–†–£–í–ê–ù–ù–Ø –ö–õ–ê–í–Ü–ê–¢–£–†–û–Æ --- ‚úÖ
            const keyMap = {
                ArrowUp: "forward",
                w: "forward",
                W: "forward",
                ArrowDown: "backward",
                s: "backward",
                S: "backward",
                ArrowLeft: "left",
                a: "left",
                A: "left",
                ArrowRight: "right",
                d: "right",
                D: "right",
            };

            let activeKeys = new Set();

            function updateMovementFromKeys() {
                let direction = null,
                    turn = null;
                if (
                    activeKeys.has("w") ||
                    activeKeys.has("W") ||
                    activeKeys.has("ArrowUp")
                )
                    direction = "forward";
                else if (
                    activeKeys.has("s") ||
                    activeKeys.has("S") ||
                    activeKeys.has("ArrowDown")
                )
                    direction = "backward";
                if (
                    activeKeys.has("a") ||
                    activeKeys.has("A") ||
                    activeKeys.has("ArrowLeft")
                )
                    turn = "left";
                else if (
                    activeKeys.has("d") ||
                    activeKeys.has("D") ||
                    activeKeys.has("ArrowRight")
                )
                    turn = "right";
                sendCommand(direction, turn, speedSlider.value);
            }

            document.addEventListener("keydown", (e) => {
                if (document.activeElement.tagName === "INPUT") return;

                const key = e.key;
                if (key === " ") {
                    e.preventDefault();
                    sendCommand(null, null, 0);
                    activeKeys.clear();
                    return;
                }
                if (keyMap[key] && !activeKeys.has(key)) {
                    e.preventDefault();
                    activeKeys.add(key);
                    updateMovementFromKeys();
                }
            });

            document.addEventListener("keyup", (e) => {
                const key = e.key;
                if (activeKeys.delete(key)) {
                    e.preventDefault();
                    updateMovementFromKeys();
                }
            });
        </script>
    </body>
</html>
